{"version":3,"file":"PlayController.js","sourceRoot":"","sources":["../../../../src/lib/controller/play/PlayController.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,6DAA6D;AAC7D,aAAa;AACb,8CAAuB;AAEvB,0EAA2C;AAC3C,qDAA+C;AAC/C,mDAAoD;AACpD,qCAA4C;AAE5C,oFAA4D;AAC5D,6EAAqD;AAGrD,+EAAuD;AAIvD,oDAAkC;AAClC,2DAAuE;AAEvE,MAAqB,cAAc;IAOjC;;QALA,4CAAgB;QAChB,6DAA+D;QAC/D,kDAAyC;QACzC,kDAAkC;QAGhC,uBAAA,IAAI,6BAAc,wBAAO,CAAC,YAAY,EAAE,MAAA,CAAC;QACzC,uBAAA,IAAI,8CAA+B,IAAI,0BAA0B,EAAE,MAAA,CAAC;QACpE,uBAAA,IAAI,mCAAoB,IAAI,MAAA,CAAC;QAC7B,uBAAA,IAAI,mCAAoB,IAAI,oCAAe,CAAC;YAC1C,WAAW,EAAE,SAAS;YACtB,kBAAkB,EAAE,wBAAO,CAAC,kBAAkB;YAC9C,YAAY,EAAE,wBAAO,CAAC,eAAe,EAAE;YACvC,SAAS,EAAE,wBAAO,CAAC,YAAY,EAAE;YACjC,cAAc,EAAE,CAAC,GAAG,EAAE,EAAE,CAAC,wBAAO,CAAC,cAAc,CAAC,GAAG,CAAC;YACpD,gBAAgB,EAAE,uBAAA,IAAI,mEAAkB,CAAC,IAAI,CAAC,IAAI,CAAC;YACnD,MAAM,EAAE;gBACN,IAAI,EAAE,CAAC,GAAG,EAAE,EAAE,CAAC,wBAAO,CAAC,SAAS,EAAE,CAAC,IAAI,CAAC,aAAa,GAAG,EAAE,CAAC;gBAC3D,IAAI,EAAE,CAAC,GAAG,EAAE,EAAE,CAAC,wBAAO,CAAC,SAAS,EAAE,CAAC,IAAI,CAAC,aAAa,GAAG,EAAE,CAAC;gBAC3D,KAAK,EAAE,CAAC,GAAG,EAAE,EAAE,CAAC,wBAAO,CAAC,SAAS,EAAE,CAAC,KAAK,CAAC,aAAa,GAAG,EAAE,CAAC;aAC9D;SACF,CAAC,MAAA,CAAC;QACH,uBAAA,IAAI,uCAAiB,CAAC,EAAE,CAAC,QAAQ,EAAE,CAAC,EAAC,KAAK,EAAC,EAAE,EAAE;YAC7C,IAAI,KAAK,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;gBACvB,wBAAO,CAAC,KAAK,CAAC,MAAM,EAAE,wBAAO,CAAC,OAAO,CAAC,2BAA2B,CAAC,CAAC,CAAC;YACtE,CAAC;iBACI,IAAI,KAAK,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;gBAC1B,wBAAO,CAAC,KAAK,CAAC,SAAS,EAAE,wBAAO,CAAC,OAAO,CAAC,wBAAwB,EAAE,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC;YACpF,CAAC;iBACI,CAAC;gBACJ,wBAAO,CAAC,KAAK,CAAC,SAAS,EAAE,wBAAO,CAAC,OAAO,CAAC,+BAA+B,EAAE,KAAK,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC;YAC7F,CAAC;QACH,CAAC,CAAC,CAAC;IACL,CAAC;IAED,KAAK;QACH,uBAAA,IAAI,uCAAiB,CAAC,OAAO,EAAE,CAAC;QAChC,uBAAA,IAAI,kDAA4B,EAAE,KAAK,EAAE,CAAC;QAC1C,uBAAA,IAAI,8CAA+B,IAAI,MAAA,CAAC;IAC1C,CAAC;IAED;;;;OAIG;IACH,KAAK,CAAC,iBAAiB,CAAC,KAAgB;QACtC,wBAAO,CAAC,SAAS,EAAE,CAAC,IAAI,CAAC,qCAAqC,KAAK,CAAC,GAAG,EAAE,CAAC,CAAC;QAE3E,uBAAA,IAAI,iEAAgB,MAApB,IAAI,CAAkB,CAAC;QACvB,uBAAA,IAAI,kDAA4B,EAAE,qBAAqB,EAAE,CAAC;QAE1D,IAAI,CAAC,wBAAO,CAAC,cAAc,CAAC,uBAAuB,CAAC,EAAE,CAAC;YACrD,wBAAO,CAAC,KAAK,CAAC,OAAO,EAAE,wBAAO,CAAC,OAAO,CAAC,oCAAoC,CAAC,CAAC,CAAC;YAC9E,OAAO;QACT,CAAC;QAED,MAAM,EAAC,OAAO,EAAE,IAAI,EAAE,YAAY,EAAC,GAAG,MAAM,EAAc,CAAC,sBAAsB,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;QAE7F,IAAI,CAAC,YAAY,EAAE,CAAC;YAClB,MAAM,KAAK,CAAC,uCAAuC,OAAO,GAAG,CAAC,CAAC;QACjE,CAAC;QAED,MAAM,MAAM,GAAG,YAAY,CAAC,MAAM,CAAC;QACnC,IAAI,CAAC,MAAM,EAAE,GAAG,EAAE,CAAC;YACjB,wBAAO,CAAC,KAAK,CAAC,OAAO,EAAE,wBAAO,CAAC,OAAO,CAAC,uBAAuB,EAAE,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC;YAC7E,MAAM,KAAK,CAAC,yBAAyB,OAAO,EAAE,CAAC,CAAC;QAClD,CAAC;QAED,MAAM,EAAE,GAAG,wBAAO,CAAC,eAAe,EAAE,CAAC;QAErC,uBAAA,IAAI,8EAA6B,MAAjC,IAAI,EAA8B,KAAK,EAAE,YAAY,CAAC,CAAC;QACvD,IAAI,YAAY,CAAC,QAAQ,EAAE,CAAC;YAC1B;;;;;eAKG;YACH,EAAE,CAAC,mBAAmB,GAAG,YAAY,CAAC,QAAQ,GAAG,IAAI,CAAC;QACxD,CAAC;QAED,uBAAA,IAAI,uCAAiB,CAAC,MAAM,EAAE,CAAC;QAE/B,MAAM,aAAa,GAAG,MAAM,CAAC,GAAG,CAAC,OAAO,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC;QACtD,MAAM,uBAAA,IAAI,yDAAQ,MAAZ,IAAI,EAAS,aAAa,EAAE,KAAK,CAAC,CAAC;QAEzC,IAAI,wBAAO,CAAC,cAAc,CAAC,cAAc,CAAC,EAAE,CAAC;YAC3C,IAAI,CAAC;gBACH,KAAK,YAAY,CAAC,YAAY,EAAE,CAAC;YACnC,CAAC;YACD,OAAO,KAAK,EAAE,CAAC;gBACb,wBAAO,CAAC,SAAS,EAAE,CAAC,KAAK,CAAC,wBAAO,CAAC,eAAe,CAAC,mDAAmD,OAAO,KAAK,EAAE,KAAK,CAAC,CAAC,CAAC;YAC7H,CAAC;QACH,CAAC;IACH,CAAC;IAeD,uBAAuB;IACvB,IAAI;QACF,uBAAA,IAAI,uCAAiB,CAAC,OAAO,EAAE,CAAC;QAChC,wBAAO,CAAC,eAAe,EAAE,CAAC,uBAAuB,CAAC,KAAK,EAAE,IAAI,EAAE,KAAK,CAAC,CAAC;QACtE,OAAO,uBAAA,IAAI,iCAAW,CAAC,IAAI,EAAE,CAAC;IAChC,CAAC;IAED,uBAAuB;IACvB,KAAK;QACH,wBAAO,CAAC,eAAe,EAAE,CAAC,uBAAuB,CAAC,KAAK,EAAE,IAAI,EAAE,KAAK,CAAC,CAAC;QACtE,OAAO,uBAAA,IAAI,iCAAW,CAAC,KAAK,EAAE,CAAC;IACjC,CAAC;IAED,uBAAuB;IACvB,MAAM;QACJ,wBAAO,CAAC,eAAe,EAAE,CAAC,uBAAuB,CAAC,KAAK,EAAE,IAAI,EAAE,KAAK,CAAC,CAAC;QACtE,OAAO,uBAAA,IAAI,iCAAW,CAAC,MAAM,EAAE,CAAC;IAClC,CAAC;IAED,uBAAuB;IACvB,IAAI,CAAC,QAAgB;QACnB,wBAAO,CAAC,eAAe,EAAE,CAAC,uBAAuB,CAAC,KAAK,EAAE,IAAI,EAAE,KAAK,CAAC,CAAC;QACtE,OAAO,uBAAA,IAAI,iCAAW,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;IACxC,CAAC;IAED,uBAAuB;IACvB,IAAI;QACF,wBAAO,CAAC,eAAe,EAAE,CAAC,uBAAuB,CAAC,KAAK,EAAE,IAAI,EAAE,KAAK,CAAC,CAAC;QACtE,OAAO,uBAAA,IAAI,iCAAW,CAAC,IAAI,EAAE,CAAC;IAChC,CAAC;IAED,uBAAuB;IACvB,QAAQ;QACN,wBAAO,CAAC,eAAe,EAAE,CAAC,uBAAuB,CAAC,SAAS,CAAC,CAAC;QAC7D,OAAO,wBAAO,CAAC,eAAe,EAAE,CAAC,QAAQ,EAAE,CAAC;IAC9C,CAAC;IAED,MAAM,CAAC,KAAK,CAAC,sBAAsB,CAAC,GAAqB,EAAE,MAAoB;QAC7E,MAAM,QAAQ,GAAG,uBAAa,CAAC,2BAA2B,CAAC,GAAG,CAAC,EAAE,QAAQ,CAAC;QAC1E,MAAM,OAAO,GAAG,QAAQ,EAAE,OAAO,EAAE,OAAO,CAAC;QAE3C,IAAI,CAAC,OAAO,EAAE,CAAC;YACb,MAAM,KAAK,CAAC,sBAAsB,GAAG,EAAE,CAAC,CAAC;QAC3C,CAAC;QAED,MAAM,KAAK,GAAG,eAAK,CAAC,WAAW,CAAC,iBAAS,CAAC,SAAS,CAAC,CAAC;QACrD,OAAO;YACL,OAAO;YACP,IAAI,EAAE,MAAM,KAAK,CAAC,eAAe,CAAC,QAAQ,EAAE,MAAM,CAAC;SACpD,CAAC;IACJ,CAAC;IAyID,KAAK,CAAC,QAAQ,CAAC,KAAgB;QAC7B,8BAA8B;QAC9B,uBAAA,IAAI,iEAAgB,MAApB,IAAI,CAAkB,CAAC;QACvB,MAAM,eAAe,GAAG,wBAAO,CAAC,cAAc,CAAC,UAAU,CAAC,CAAC;QAC3D,IAAI,CAAC,eAAe,EAAE,CAAC;YACrB;;;;;;;;eAQG;YACH,wBAAO,CAAC,SAAS,EAAE,CAAC,IAAI,CAAC,kCAAkC,CAAC,CAAC;YAC7D,wBAAO,CAAC,eAAe,EAAE,CAAC,YAAY,GAAG,KAAK,CAAC;YAC/C,OAAO;QACT,CAAC;QACD,IAAI,SAAS,CAAC;QACd,gDAAgD;QAChD,oEAAoE;QACpE,wEAAwE;QACxE,yDAAyD;QACzD,wBAAO,CAAC,eAAe,EAAE,CAAC,YAAY,GAAG,KAAK,CAAC;QAC/C,uBAAA,IAAI,mCAAoB,IAAI,eAAe,EAAE,MAAA,CAAC;QAC9C,MAAM,MAAM,GAAG,uBAAA,IAAI,uCAAiB,CAAC,MAAM,CAAC;QAC5C,IAAI,CAAC;YACH,MAAM,EAAE,OAAO,EAAE,IAAI,EAAE,YAAY,EAAE,GAAG,MAAM,EAAc,CAAC,sBAAsB,CAAC,KAAK,CAAC,GAAG,EAAE,MAAM,CAAC,CAAC;YACvG,SAAS,GAAG,YAAY,EAAE,MAAM,EAAE,GAAG,CAAC;YACtC,IAAI,CAAC,SAAS,IAAI,CAAC,YAAY,EAAE,CAAC;gBAChC,MAAM,KAAK,CAAC,0BAA0B,OAAO,GAAG,CAAC,CAAC;YACpD,CAAC;YACD,uBAAA,IAAI,8EAA6B,MAAjC,IAAI,EAA8B,KAAK,EAAE,YAAY,CAAC,CAAC;YACvD,wBAAO,CAAC,eAAe,EAAE,CAAC,YAAY,GAAG,IAAI,CAAC;QAChD,CAAC;QACD,OAAO,KAAU,EAAE,CAAC;YAClB,IAAI,MAAM,CAAC,OAAO,EAAE,CAAC;gBACnB,wBAAO,CAAC,SAAS,EAAE,CAAC,IAAI,CAAC,oCAAoC,KAAK,CAAC,IAAI,EAAE,CAAC,CAAC;gBAC3E,OAAO;YACT,CAAC;YACD,wBAAO,CAAC,SAAS,EAAE,CAAC,KAAK,CAAC,mCAAmC,KAAK,EAAE,CAAC,CAAC;YACtE,OAAO;QACT,CAAC;gBACO,CAAC;YACP,uBAAA,IAAI,mCAAoB,IAAI,MAAA,CAAC;QAC/B,CAAC;QAED,MAAM,SAAS,GAAG,uBAAA,IAAI,iCAAW,CAAC;QAClC,MAAM,GAAG,GAAG,MAAM,IAAA,qBAAc,EAAC,SAAS,CAAC,cAAc,CAAC,UAAU,uBAAA,IAAI,6EAA4B,MAAhC,IAAI,EAA6B,SAAS,CAAC,GAAG,EAAE,EAAE,CAAC;aACpH,IAAI,CAAC,CAAC,SAAyB,EAAE,EAAE,CAAC,uBAAA,IAAI,6DAAY,MAAhB,IAAI,EAAa,SAAS,EAAE,KAAK,CAAC,CAAC;aACvE,IAAI,CAAC,GAAG,EAAE;YACT,wBAAO,CAAC,SAAS,EAAE,CAAC,IAAI,CAAC,2DAA2D,KAAK,CAAC,IAAI,EAAE,CAAC,CAAC;YAClG,OAAO,SAAS,CAAC,cAAc,CAAC,WAAW,EAAE,EAAE,CAAC,CAAC;QACnD,CAAC,CAAC,CAAC,CAAC;QAEN,uBAAA,IAAI,kDAA4B,EAAE,gBAAgB,CAAC,KAAK,CAAC,CAAC;QAE1D,OAAO,GAAG,CAAC;IACb,CAAC;IASD,KAAK,CAAC,UAAU,CAAC,IAAwB,EAAE,GAAqB;QAC9D,MAAM,YAAY,GAAG,CAAC,MAAM,EAAc,CAAC,sBAAsB,CAAC,GAAG,CAAC,CAAC,EAAE,IAAI,CAAC;QAC9E,IAAI,CAAC,YAAY,EAAE,CAAC;YAClB,OAAO,IAAI,CAAC;QACd,CAAC;QAED,IAAI,IAAI,KAAK,OAAO,IAAI,YAAY,CAAC,KAAK,CAAC,OAAO,EAAE,CAAC;YACnD,MAAM,UAAU,GAAc;gBAC5B,IAAI,EAAE,OAAO;gBACb,SAAS,EAAE;oBACT,MAAM,EAAE;wBACN,IAAI,EAAE,uBAAY,CAAC,MAAM;wBACzB,OAAO,EAAE;4BACP,QAAQ,EAAE,YAAY,CAAC,KAAK,CAAC,OAAO;yBACrC;qBACF;oBACD,yFAAyF;oBACzF,KAAK,EAAE;wBACL,IAAI,EAAE,uBAAY,CAAC,KAAK;wBACxB,OAAO,EAAE;4BACP,UAAU,EAAE,YAAY,CAAC,KAAK,CAAC,OAAO;yBACvC;qBACF;iBACF;aACF,CAAC;YACF,OAAO,WAAW,oBAAU,CAAC,2BAA2B,CAAC,UAAU,CAAC,EAAE,CAAC;QACzE,CAAC;QAED,IAAI,IAAI,KAAK,QAAQ,IAAI,YAAY,CAAC,MAAM,CAAC,SAAS,EAAE,CAAC;YACvD,MAAM,UAAU,GAAgB;gBAC9B,IAAI,EAAE,SAAS;gBACf,QAAQ,EAAE;oBACR,IAAI,EAAE,uBAAY,CAAC,MAAM;oBACzB,OAAO,EAAE;wBACP,QAAQ,EAAE,YAAY,CAAC,MAAM,CAAC,SAAS;qBACxC;iBACF;aACF,CAAC;YACF,OAAO,WAAW,oBAAU,CAAC,2BAA2B,CAAC,UAAU,CAAC,EAAE,CAAC;QACzE,CAAC;QAED,OAAO,IAAI,CAAC;IACd,CAAC;CACF;4WAtT8B,KAAgB,EAAE,YAAmC;IAChF,KAAK,CAAC,KAAK,GAAG,YAAY,CAAC,KAAK,IAAI,KAAK,CAAC,KAAK,CAAC;IAChD,KAAK,CAAC,IAAI,GAAG,YAAY,CAAC,KAAK,IAAI,KAAK,CAAC,KAAK,CAAC;IAC/C,KAAK,CAAC,MAAM,GAAG,YAAY,CAAC,MAAM,EAAE,IAAI,IAAI,KAAK,CAAC,MAAM,CAAC;IACzD,KAAK,CAAC,KAAK,GAAG,YAAY,CAAC,KAAK,EAAE,KAAK,IAAI,KAAK,CAAC,KAAK,CAAC;IACvD,KAAK,CAAC,QAAQ,GAAG,YAAY,CAAC,SAAS,IAAI,KAAK,CAAC,QAAQ,CAAC;IAC1D,KAAK,CAAC,QAAQ,GAAG,YAAY,CAAC,QAAQ,CAAC;IACvC,IAAI,YAAY,CAAC,MAAM,EAAE,OAAO,EAAE,CAAC;QACjC,KAAK,CAAC,UAAU,GAAG,YAAY,CAAC,MAAM,CAAC,OAAO,CAAC;IACjD,CAAC;IACD,OAAO,KAAK,CAAC;AACf,CAAC,2DAsDO,SAAiB,EAAE,KAAgB;IACzC,MAAM,SAAS,GAAG,uBAAA,IAAI,iCAAW,CAAC;IAElC,OAAO,IAAA,qBAAc,EAAC,SAAS,CAAC,cAAc,CAAC,MAAM,EAAE,EAAE,CAAC;SACvD,IAAI,CAAC,GAAG,EAAE;QACT,OAAO,SAAS,CAAC,cAAc,CAAC,OAAO,EAAE,EAAE,CAAC,CAAC;IAC/C,CAAC,CAAC;SACD,IAAI,CAAC,GAAG,EAAE;QACT,OAAO,SAAS,CAAC,cAAc,CAAC,UAAU,uBAAA,IAAI,6EAA4B,MAAhC,IAAI,EAA6B,SAAS,CAAC,GAAG,EAAE,EAAE,CAAC,CAAC;IAChG,CAAC,CAAC;SACD,IAAI,CAAC,CAAC,SAAyB,EAAE,EAAE,CAAC,uBAAA,IAAI,6DAAY,MAAhB,IAAI,EAAa,SAAS,EAAE,KAAK,CAAC,CAAC;SACvE,IAAI,CAAC,GAAG,EAAE;QACT,wBAAO,CAAC,eAAe,EAAE,CAAC,uBAAuB,CAAC,KAAK,EAAE,IAAI,EAAE,KAAK,CAAC,CAAC;QACtE,OAAO,SAAS,CAAC,cAAc,CAAC,MAAM,EAAE,EAAE,CAAC,CAAC;IAC9C,CAAC,CAAC,CAAC,CAAC;AACR,CAAC,mGAE2B,GAAW;IACrC;;;OAGG;IACH,OAAO,GAAG,GAAG,YAAY,CAAC;AAC5B,CAAC,mEAGW,gBAAgC,EAAE,KAAgB;IAC5D,MAAM,MAAM,GAAG,gBAAgB,EAAE,EAAE,CAAC;IACpC,IAAI,MAAM,KAAK,SAAS,EAAE,CAAC;QACzB,MAAM,IAAI,GAAG,EAAE,CAAC;QAChB,IAAI,CAAC,IAAI,CAAC;YACR,OAAO,EAAE,UAAU;YACnB,UAAU,EAAE,CAAE,MAAM,EAAE,OAAO,EAAE,KAAK,CAAC,KAAK,CAAE;SAC7C,CAAC,CAAC;QACH,IAAI,KAAK,CAAC,KAAK,EAAE,CAAC;YAChB,IAAI,CAAC,IAAI,CAAC;gBACR,OAAO,EAAE,UAAU;gBACnB,UAAU,EAAE,CAAE,MAAM,EAAE,OAAO,EAAE,KAAK,CAAC,KAAK,CAAE;aAC7C,CAAC,CAAC;QACL,CAAC;QACD,IAAI,CAAC,IAAI,CAAC;YACR,OAAO,EAAE,UAAU;YACnB,UAAU,EAAE,CAAE,MAAM,EAAE,QAAQ,EAAE,KAAK,CAAC,MAAM,CAAE;SAC/C,CAAC,CAAC;QAEH,OAAO,uBAAA,IAAI,iCAAW,CAAC,mBAAmB,CAAC,IAAI,CAAC,CAAC;IACnD,CAAC;IACD,OAAO,aAAI,CAAC,OAAO,EAAE,CAAC;AACxB,CAAC,qCAED,KAAK,2CAAmB,gBAAkC;IACxD,MAAM,iBAAiB,GAAG,uBAAa,CAAC,2BAA2B,CAAC,gBAAgB,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;IAChG,MAAM,eAAe,GAAG,iBAAiB,EAAE,eAAe,CAAC;IAE3D,IAAI,eAAe,EAAE,CAAC;QACpB,wBAAO,CAAC,SAAS,EAAE,CAAC,IAAI,CAAC,2DAA2D,IAAI,CAAC,SAAS,CAAC,eAAe,CAAC,aAAa,CAAC,EAAE,CAAC,CAAC;IACvI,CAAC;SACI,CAAC;QACJ,wBAAO,CAAC,SAAS,EAAE,CAAC,IAAI,CAAC,6CAA6C,CAAC,CAAC;IAC1E,CAAC;IAED,MAAM,aAAa,GAAG,eAAK,CAAC,WAAW,CAAC,iBAAS,CAAC,QAAQ,CAAC,CAAC;IAC5D,MAAM,QAAQ,GAAG,eAAe,CAAC,CAAC,CAAC,MAAM,aAAa,CAAC,WAAW,CAAC,eAAe,CAAC,aAAa,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC;IAEzG,MAAM,aAAa,GAA4B,EAAE,CAAC;IAClD,IAAI,kBAAkB,GAA2B,IAAI,CAAC;IAEtD,IAAI,QAAQ,EAAE,CAAC;QACb,IAAI,KAAK,CAAC;QACV,IAAI,QAAQ,CAAC,cAAc,EAAE,CAAC,CAAC,2BAA2B;YACxD,KAAK,GAAG,QAAQ,CAAC,KAAK,CAAC;QACzB,CAAC;aACI,CAAC,CAAC,eAAe;YACpB,KAAK,GAAG,QAAQ,CAAC,QAAQ,EAAE,KAAK,CAAC;QACnC,CAAC;QACD,IAAI,KAAK,EAAE,CAAC;YACV,MAAM,mBAAmB,GAAG,eAAe,EAAE,aAAa,CAAC,OAAO,CAAC,OAAO,CAAC;YAC3E,IAAI,YAAY,GAAG,CAAC,CAAC;YACrB,IAAI,mBAAmB,EAAE,CAAC;gBACxB,YAAY,GAAG,KAAK,EAAE,SAAS,CAAC,CAAC,IAAI,EAAE,EAAE,CAAC,IAAI,CAAC,OAAO,KAAK,mBAAmB,CAAC,IAAI,CAAC,CAAC;YACvF,CAAC;YACD,IAAI,YAAY,GAAG,CAAC,EAAE,CAAC;gBACrB,YAAY,GAAG,CAAC,CAAC;YACnB,CAAC;YACD,MAAM,UAAU,GAAG,KAAK,EAAE,KAAK,CAAC,YAAY,GAAG,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC,IAAI,EAAE,EAAE,CAAC,IAAI,CAAC,IAAI,KAAK,OAAO,IAAI,IAAI,CAAC,IAAI,KAAK,MAAM,CAAC,IAAI,EAAE,CAAC;YACxH,aAAa,CAAC,IAAI,CAAC,GAAG,UAAU,CAAC,CAAC;YAClC,wBAAO,CAAC,SAAS,EAAE,CAAC,IAAI,CAAC,2BAA2B,UAAU,CAAC,MAAM,2CAA2C,CAAC,CAAC;YAClH,IAAI,UAAU,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;gBAC1B,kBAAkB,GAAG,wBAAc,CAAC,kBAAkB,CAAC,QAAQ,CAAC,CAAC;YACnE,CAAC;QACH,CAAC;QAED,IAAI,aAAa,CAAC,MAAM,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,cAAc,IAAI,QAAQ,CAAC,OAAO,EAAE,CAAC;YAC9E,MAAM,eAAe,GAAG,MAAM,aAAa,CAAC,WAAW,CAAC,QAAQ,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC;YACnF,MAAM,KAAK,GAAG,eAAe,EAAE,QAAQ,EAAE,KAAK,CAAC;YAC/C,IAAI,KAAK,EAAE,CAAC;gBACV,aAAa,CAAC,IAAI,CAAC,GAAG,KAAK,CAAC,CAAC;gBAC7B,wBAAO,CAAC,SAAS,EAAE,CAAC,IAAI,CAAC,2BAA2B,KAAK,CAAC,MAAM,kCAAkC,CAAC,CAAC;gBACpG,IAAI,KAAK,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;oBACrB,kBAAkB,GAAG,wBAAc,CAAC,kBAAkB,CAAC,eAAe,CAAC,CAAC;gBAC1E,CAAC;YACH,CAAC;QACH,CAAC;IACH,CAAC;IAED,IAAI,aAAa,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;QAC/B,4CAA4C;QAC5C,MAAM,YAAY,GAAG,MAAM,EAAc,CAAC,sBAAsB,CAAC,gBAAgB,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;QAC7F,MAAM,aAAa,GAAG,YAAY,CAAC,IAAI,EAAE,aAAa,CAAC;QACvD,IAAI,aAAa,IAAI,CAAC,CAAC,eAAe,IAAI,aAAa,CAAC,OAAO,CAAC,UAAU,KAAK,eAAe,CAAC,aAAa,CAAC,OAAO,CAAC,UAAU,CAAC,EAAE,CAAC;YACjI,MAAM,aAAa,GAAG,MAAM,aAAa,CAAC,WAAW,CAAC,aAAa,CAAC,CAAC;YACrE,MAAM,KAAK,GAAG,aAAa,EAAE,QAAQ,EAAE,KAAK,CAAC;YAC7C,IAAI,KAAK,EAAE,CAAC;gBACV,MAAM,YAAY,GAAG,KAAK,CAAC,SAAS,CAAC,CAAC,IAAI,EAAE,EAAE,CAAC,IAAI,CAAC,OAAO,KAAK,YAAY,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;gBAC3F,MAAM,UAAU,GAAG,KAAK,CAAC,KAAK,CAAC,YAAY,GAAG,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC,IAAI,EAAE,EAAE,CAAC,IAAI,CAAC,IAAI,KAAK,OAAO,IAAI,IAAI,CAAC,IAAI,KAAK,MAAM,CAAC,IAAI,EAAE,CAAC;gBACvH,aAAa,CAAC,IAAI,CAAC,GAAG,UAAU,CAAC,CAAC;gBAClC,wBAAO,CAAC,SAAS,EAAE,CAAC,IAAI,CAAC,2BAA2B,UAAU,CAAC,MAAM,gCAAgC,CAAC,CAAC;gBACvG,IAAI,KAAK,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;oBACrB,kBAAkB,GAAG,wBAAc,CAAC,kBAAkB,CAAC,aAAa,CAAC,CAAC;gBACxE,CAAC;YACH,CAAC;QACH,CAAC;IACH,CAAC;IAED,IAAI,kBAAkB,EAAE,CAAC;QACvB,KAAK,MAAM,IAAI,IAAI,aAAa,EAAE,CAAC;YACjC,IAAI,CAAC,eAAe,GAAG,kBAAkB,CAAC;QAC5C,CAAC;IACH,CAAC;IAED,OAAO,aAAa;SACjB,GAAG,CAAC,CAAC,IAAI,EAAE,EAAE,CAAC,uBAAa,CAAC,iCAAiC,CAAC,IAAI,CAAC,CAAC;SACpE,GAAG,CAAC,CAAC,IAAI,EAAE,EAAE,CAAC,uBAAa,CAAC,oCAAoC,CAAC,IAAI,CAAC,CAAC,CAAC;AAC7E,CAAC;IA+DC,IAAI,uBAAA,IAAI,uCAAiB,EAAE,CAAC;QAC1B,uBAAA,IAAI,uCAAiB,CAAC,KAAK,EAAE,CAAC;QAC9B,uBAAA,IAAI,mCAAoB,IAAI,MAAA,CAAC;IAC/B,CAAC;AACH,CAAC;kBA5WkB,cAAc;AA2ZnC;;;;;;;;;;;;GAYG;AACH,MAAM,0BAA2B,SAAQ,gBAAY;IAMnD;QACE,KAAK,EAAE,CAAC;;QALV,iEAA4B;QAC5B,8DAAmC;QACnC,uEAAyD;QAIvD,uBAAA,IAAI,kDAAuB,CAAC,CAAC,MAAA,CAAC;QAC9B,uBAAA,IAAI,+CAAoB,IAAI,MAAA,CAAC;IAC/B,CAAC;IAED,KAAK;QACH,uBAAA,IAAI,kGAAyB,MAA7B,IAAI,CAA2B,CAAC;QAChC,IAAI,CAAC,kBAAkB,EAAE,CAAC;IAC5B,CAAC;IAED,gBAAgB,CAAC,KAAgB;QAC/B,uBAAA,IAAI,kDAAuB,wBAAO,CAAC,eAAe,EAAE,CAAC,eAAe,MAAA,CAAC;QACrE,uBAAA,IAAI,+CAAoB,KAAK,MAAA,CAAC;QAC9B,uBAAA,IAAI,+FAAsB,MAA1B,IAAI,CAAwB,CAAC;IAC/B,CAAC;IAED,qBAAqB;QACnB,uBAAA,IAAI,kGAAyB,MAA7B,IAAI,CAA2B,CAAC;IAClC,CAAC;IA+CD,IAAI,CAAC,KAAsB,EAAE,GAAG,IAAW;QACzC,OAAO,KAAK,CAAC,IAAI,CAAC,KAAK,EAAE,GAAG,IAAI,CAAC,CAAC;IACpC,CAAC;IAGD,EAAE,CAAC,KAAsB,EAAE,QAAkC;QAC3D,KAAK,CAAC,EAAE,CAAC,KAAK,EAAE,QAAQ,CAAC,CAAC;QAC1B,OAAO,IAAI,CAAC;IACd,CAAC;CACF;;IArDG,IAAI,CAAC,uBAAA,IAAI,4DAA0B,EAAE,CAAC;QACpC,uBAAA,IAAI,wDAA6B,uBAAA,IAAI,iGAAwB,CAAC,IAAI,CAAC,IAAI,CAAC,MAAA,CAAC;QACzE,wBAAO,CAAC,kBAAkB,EAAE,WAAW,CAAC,kBAAkB,EAAE,uBAAA,IAAI,4DAA0B,CAAC,CAAC;IAC9F,CAAC;AACH,CAAC;IAGC,IAAI,uBAAA,IAAI,4DAA0B,EAAE,CAAC;QACnC,MAAM,SAAS,GAAG,wBAAO,CAAC,kBAAkB,EAAE,SAAS,EAAE,CAAC,kBAAkB,CAAC,IAAI,EAAE,CAAC;QACpF,MAAM,KAAK,GAAG,SAAS,CAAC,OAAO,CAAC,uBAAA,IAAI,4DAA0B,CAAC,CAAC;QAChE,IAAI,KAAK,IAAI,CAAC,EAAE,CAAC;YACf,wBAAO,CAAC,kBAAkB,CAAC,SAAS,CAAC,kBAAkB,CAAC,CAAC,MAAM,CAAC,KAAK,EAAE,CAAC,CAAC,CAAC;QAC5E,CAAC;QACD,uBAAA,IAAI,wDAA6B,IAAI,MAAA,CAAC;QACtC,uBAAA,IAAI,kDAAuB,CAAC,CAAC,MAAA,CAAC;QAC9B,uBAAA,IAAI,+CAAoB,IAAI,MAAA,CAAC;IAC/B,CAAC;AACH,CAAC,mHAEuB,KAAU;IAChC,MAAM,EAAE,GAAG,wBAAO,CAAC,eAAe,EAAE,CAAC;IACrC,MAAM,eAAe,GAAG,EAAE,CAAC,eAAyB,CAAC;IACrD,IAAI,EAAE,CAAC,QAAQ,EAAE,CAAC,OAAO,KAAK,SAAS,EAAE,CAAC;QACxC,uBAAA,IAAI,kGAAyB,MAA7B,IAAI,CAA2B,CAAC;QAChC,OAAO;IACT,CAAC;IACD,IAAI,uBAAA,IAAI,sDAAoB,IAAI,CAAC,IAAI,uBAAA,IAAI,sDAAoB,KAAK,eAAe,EAAE,CAAC;QAClF,MAAM,KAAK,GAAG,EAAE,CAAC,QAAQ,CAAC,eAAe,CAAC,CAAC;QAC3C,MAAM,EAAE,GAAG,uBAAA,IAAI,mDAAiB,CAAC;QACjC,uBAAA,IAAI,kGAAyB,MAA7B,IAAI,CAA2B,CAAC;QAChC,IAAI,KAAK,IAAI,KAAK,IAAI,EAAE,IAAI,KAAK,CAAC,OAAO,KAAK,SAAS,IAAI,EAAE,CAAC,GAAG,KAAK,KAAK,CAAC,GAAG,EAAE,CAAC;YAChF,IAAI,KAAK,CAAC,GAAG,KAAK,KAAK,CAAC,GAAG,EAAE,CAAC;gBAC5B,MAAM,SAAS,GAAG,wBAAO,CAAC,YAAY,EAAE,CAAC;gBACzC,SAAS,CAAC,QAAQ,EAAE,CAAC,IAAI,CAAC,CAAC,EAAO,EAAE,EAAE,CAAC,SAAS,CAAC,SAAS,CAAC,EAAE,CAAC,CAAC,CAAC;YAClE,CAAC;YACD,IAAI,CAAC,IAAI,CAAC,cAAc,EAAE;gBACxB,KAAK,EAAE,EAAE;gBACT,QAAQ,EAAE,eAAe;aAC1B,CAAC,CAAC;QACL,CAAC;IACH,CAAC;AACH,CAAC","sourcesContent":["// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n// @ts-ignore\nimport libQ from 'kew';\n\nimport ytmusic from '../../YTMusicContext';\nimport Model, { ModelType } from '../../model';\nimport { EndpointType } from '../../types/Endpoint';\nimport { kewToJSPromise } from '../../util';\nimport { type QueueItem } from '../browse/view-handlers/ExplodableViewHandler';\nimport ViewHelper from '../browse/view-handlers/ViewHelper';\nimport ExplodeHelper from '../../util/ExplodeHelper';\nimport { type ContentItem } from '../../types';\nimport type MusicItemPlaybackInfo from '../../types/MusicItemPlaybackInfo';\nimport AutoplayHelper from '../../util/AutoplayHelper';\nimport type AutoplayContext from '../../types/AutoplayContext';\nimport { type AlbumView } from '../browse/view-handlers/AlbumViewHandler';\nimport { type GenericView } from '../browse/view-handlers/GenericViewHandler';\nimport EventEmitter from 'events';\nimport { AutoplayManager, LastPlaybackInfo } from 'volumio-yt-support';\n\nexport default class PlayController {\n\n  #mpdPlugin: any;\n  #prefetchPlaybackStateFixer: PrefetchPlaybackStateFixer | null;\n  #prefetchAborter: AbortController | null;\n  #autoplayManager: AutoplayManager;\n\n  constructor() {\n    this.#mpdPlugin = ytmusic.getMpdPlugin();\n    this.#prefetchPlaybackStateFixer = new PrefetchPlaybackStateFixer();\n    this.#prefetchAborter = null;\n    this.#autoplayManager = new AutoplayManager({\n      serviceName: 'ytmusic',\n      volumioCoreCommand: ytmusic.volumioCoreCommand,\n      stateMachine: ytmusic.getStateMachine(),\n      mpdPlugin: ytmusic.getMpdPlugin(),\n      getConfigValue: (key) => ytmusic.getConfigValue(key),\n      getAutoplayItems: this.#getAutoplayItems.bind(this),\n      logger: {\n        info: (msg) => ytmusic.getLogger().info(`[ytmusic] ${msg}`),\n        warn: (msg) => ytmusic.getLogger().warn(`[ytmusic] ${msg}`),\n        error: (msg) => ytmusic.getLogger().error(`[ytmusic] ${msg}`),\n      }\n    });\n    this.#autoplayManager.on('queued', ({items}) => {\n      if (items.length === 0) {\n        ytmusic.toast('info', ytmusic.getI18n('YTMUSIC_AUTOPLAY_NO_ITEMS'));\n      }\n      else if (items.length > 1) {\n        ytmusic.toast('success', ytmusic.getI18n('YTMUSIC_AUTOPLAY_ADDED', items.length));\n      }\n      else {\n        ytmusic.toast('success', ytmusic.getI18n('YTMUSIC_AUTOPLAY_ADDED_SINGLE', items[0].title));\n      }\n    });\n  }\n\n  reset() {\n    this.#autoplayManager.disable();\n    this.#prefetchPlaybackStateFixer?.reset();\n    this.#prefetchPlaybackStateFixer = null;\n  }\n\n  /**\n   * Track uri:\n   * - ytmusic/[song|video]@@explodeTrackData={...}\n   *\n   */\n  async clearAddPlayTrack(track: QueueItem) {\n    ytmusic.getLogger().info(`[ytmusic-play] clearAddPlayTrack: ${track.uri}`);\n\n    this.#cancelPrefetch();\n    this.#prefetchPlaybackStateFixer?.notifyPrefetchCleared();\n\n    if (!ytmusic.getConfigValue('hasAcceptedDisclaimer')) {\n      ytmusic.toast('error', ytmusic.getI18n('YTMUSIC_ERR_ACCEPT_DISCLAIMER_PLAY'));\n      return;\n    }\n\n    const {videoId, info: playbackInfo} = await PlayController.getPlaybackInfoFromUri(track.uri);\n\n    if (!playbackInfo) {\n      throw Error(`Could not obtain playback info for: ${videoId})`);\n    }\n\n    const stream = playbackInfo.stream;\n    if (!stream?.url) {\n      ytmusic.toast('error', ytmusic.getI18n('YTMUSIC_ERR_NO_STREAM', track.name));\n      throw Error(`Stream not found for: ${videoId}`);\n    }\n\n    const sm = ytmusic.getStateMachine();\n\n    this.#updateTrackWithPlaybackInfo(track, playbackInfo);\n    if (playbackInfo.duration) {\n      /**\n       * Notes:\n       * - Ideally, we should have duration in `explodeTrackData` (set at browse time), but we didn't do this\n       *   plus there is no guarantee that duration is always available when browsing.\n       * - So we directly set `currentSongDuration` of statemachine -- required to trigger prefetch.\n       */\n      sm.currentSongDuration = playbackInfo.duration * 1000;\n    }\n\n    this.#autoplayManager.enable();\n\n    const safeStreamUrl = stream.url.replace(/\"/g, '\\\\\"');\n    await this.#doPlay(safeStreamUrl, track);\n\n    if (ytmusic.getConfigValue('addToHistory')) {\n      try {\n        void playbackInfo.addToHistory();\n      }\n      catch (error) {\n        ytmusic.getLogger().error(ytmusic.getErrorMessage(`[ytmusic-play] Error: could not add to history (${videoId}): `, error));\n      }\n    }\n  }\n\n  #updateTrackWithPlaybackInfo(track: QueueItem, playbackInfo: MusicItemPlaybackInfo) {\n    track.title = playbackInfo.title || track.title;\n    track.name = playbackInfo.title || track.title;\n    track.artist = playbackInfo.artist?.name || track.artist;\n    track.album = playbackInfo.album?.title || track.album;\n    track.albumart = playbackInfo.thumbnail || track.albumart;\n    track.duration = playbackInfo.duration;\n    if (playbackInfo.stream?.bitrate) {\n      track.samplerate = playbackInfo.stream.bitrate;\n    }\n    return track;\n  }\n\n  // Returns kew promise!\n  stop() {\n    this.#autoplayManager.disable();\n    ytmusic.getStateMachine().setConsumeUpdateService('mpd', true, false);\n    return this.#mpdPlugin.stop();\n  }\n\n  // Returns kew promise!\n  pause() {\n    ytmusic.getStateMachine().setConsumeUpdateService('mpd', true, false);\n    return this.#mpdPlugin.pause();\n  }\n\n  // Returns kew promise!\n  resume() {\n    ytmusic.getStateMachine().setConsumeUpdateService('mpd', true, false);\n    return this.#mpdPlugin.resume();\n  }\n\n  // Returns kew promise!\n  seek(position: number) {\n    ytmusic.getStateMachine().setConsumeUpdateService('mpd', true, false);\n    return this.#mpdPlugin.seek(position);\n  }\n\n  // Returns kew promise!\n  next() {\n    ytmusic.getStateMachine().setConsumeUpdateService('mpd', true, false);\n    return this.#mpdPlugin.next();\n  }\n\n  // Returns kew promise!\n  previous() {\n    ytmusic.getStateMachine().setConsumeUpdateService(undefined);\n    return ytmusic.getStateMachine().previous();\n  }\n\n  static async getPlaybackInfoFromUri(uri: QueueItem['uri'], signal?: AbortSignal): Promise<{videoId: string; info: MusicItemPlaybackInfo | null}> {\n    const endpoint = ExplodeHelper.getExplodedTrackInfoFromUri(uri)?.endpoint;\n    const videoId = endpoint?.payload?.videoId;\n\n    if (!videoId) {\n      throw Error(`Invalid track uri: ${uri}`);\n    }\n\n    const model = Model.getInstance(ModelType.MusicItem);\n    return {\n      videoId,\n      info: await model.getPlaybackInfo(endpoint, signal)\n    };\n  }\n\n  #doPlay(streamUrl: string, track: QueueItem) {\n    const mpdPlugin = this.#mpdPlugin;\n\n    return kewToJSPromise(mpdPlugin.sendMpdCommand('stop', [])\n      .then(() => {\n        return mpdPlugin.sendMpdCommand('clear', []);\n      })\n      .then(() => {\n        return mpdPlugin.sendMpdCommand(`addid \"${this.#appendTrackTypeToStreamUrl(streamUrl)}\"`, []);\n      })\n      .then((addIdResp: { Id: string }) => this.#mpdAddTags(addIdResp, track))\n      .then(() => {\n        ytmusic.getStateMachine().setConsumeUpdateService('mpd', true, false);\n        return mpdPlugin.sendMpdCommand('play', []);\n      }));\n  }\n\n  #appendTrackTypeToStreamUrl(url: string) {\n    /**\n     * Fool MPD plugin to return correct `trackType` in `parseTrackInfo()` by adding\n     * track type to URL query string as a dummy param.\n     */\n    return `${url}&t.YouTube`;\n  }\n\n  // Returns kew promise!\n  #mpdAddTags(mpdAddIdResponse: { Id: string }, track: QueueItem) {\n    const songId = mpdAddIdResponse?.Id;\n    if (songId !== undefined) {\n      const cmds = [];\n      cmds.push({\n        command: 'addtagid',\n        parameters: [ songId, 'title', track.title ]\n      });\n      if (track.album) {\n        cmds.push({\n          command: 'addtagid',\n          parameters: [ songId, 'album', track.album ]\n        });\n      }\n      cmds.push({\n        command: 'addtagid',\n        parameters: [ songId, 'artist', track.artist ]\n      });\n\n      return this.#mpdPlugin.sendMpdCommandArray(cmds);\n    }\n    return libQ.resolve();\n  }\n\n  async #getAutoplayItems(lastPlaybackInfo: LastPlaybackInfo): Promise<QueueItem[]> {\n    const explodedTrackInfo = ExplodeHelper.getExplodedTrackInfoFromUri(lastPlaybackInfo.track.uri);\n    const autoplayContext = explodedTrackInfo?.autoplayContext;\n\n    if (autoplayContext) {\n      ytmusic.getLogger().info(`[ytmusic-play] Obtaining autoplay videos from endpoint: ${JSON.stringify(autoplayContext.fetchEndpoint)}`);\n    }\n    else {\n      ytmusic.getLogger().info('[ytmusic-play] No autoplay context provided');\n    }\n\n    const endpointModel = Model.getInstance(ModelType.Endpoint);\n    const contents = autoplayContext ? await endpointModel.getContents(autoplayContext.fetchEndpoint) : null;\n\n    const autoplayItems: ContentItem.MusicItem[] = [];\n    let newAutoplayContext: AutoplayContext | null = null;\n\n    if (contents) {\n      let items;\n      if (contents.isContinuation) { // WatchContinuationContent\n        items = contents.items;\n      }\n      else { // WatchContent\n        items = contents.playlist?.items;\n      }\n      if (items) {\n        const continueFromVideoId = autoplayContext?.fetchEndpoint.payload.videoId;\n        let currentIndex = 0;\n        if (continueFromVideoId) {\n          currentIndex = items?.findIndex((item) => item.videoId === continueFromVideoId) || 0;\n        }\n        if (currentIndex < 0) {\n          currentIndex = 0;\n        }\n        const itemsAfter = items?.slice(currentIndex + 1).filter((item) => item.type === 'video' || item.type === 'song') || [];\n        autoplayItems.push(...itemsAfter);\n        ytmusic.getLogger().info(`[ytmusic-play] Obtained ${itemsAfter.length} items for autoplay from current playlist`);\n        if (itemsAfter.length > 0) {\n          newAutoplayContext = AutoplayHelper.getAutoplayContext(contents);\n        }\n      }\n\n      if (autoplayItems.length <= 5 && !contents.isContinuation && contents.automix) {\n        const automixContents = await endpointModel.getContents(contents.automix.endpoint);\n        const items = automixContents?.playlist?.items;\n        if (items) {\n          autoplayItems.push(...items);\n          ytmusic.getLogger().info(`[ytmusic-play] Obtained ${items.length} items for autoplay from automix`);\n          if (items.length > 0) {\n            newAutoplayContext = AutoplayHelper.getAutoplayContext(automixContents);\n          }\n        }\n      }\n    }\n\n    if (autoplayItems.length === 0) {\n      // Fetch from radio endpoint as last resort.\n      const playbackInfo = await PlayController.getPlaybackInfoFromUri(lastPlaybackInfo.track.uri);\n      const radioEndpoint = playbackInfo.info?.radioEndpoint;\n      if (radioEndpoint && (!autoplayContext || radioEndpoint.payload.playlistId !== autoplayContext.fetchEndpoint.payload.playlistId)) {\n        const radioContents = await endpointModel.getContents(radioEndpoint);\n        const items = radioContents?.playlist?.items;\n        if (items) {\n          const currentIndex = items.findIndex((item) => item.videoId === playbackInfo.videoId) || 0;\n          const itemsAfter = items.slice(currentIndex + 1).filter((item) => item.type === 'video' || item.type === 'song') || [];\n          autoplayItems.push(...itemsAfter);\n          ytmusic.getLogger().info(`[ytmusic-play] Obtained ${itemsAfter.length} items for autoplay from radio`);\n          if (items.length > 0) {\n            newAutoplayContext = AutoplayHelper.getAutoplayContext(radioContents);\n          }\n        }\n      }\n    }\n\n    if (newAutoplayContext) {\n      for (const item of autoplayItems) {\n        item.autoplayContext = newAutoplayContext;\n      }\n    }\n\n    return autoplayItems\n      .map((item) => ExplodeHelper.getExplodedTrackInfoFromMusicItem(item))\n      .map((item) => ExplodeHelper.createQueueItemFromExplodedTrackInfo(item));\n  }\n\n  async prefetch(track: QueueItem) {\n    // Cancel any ongoing prefetch\n    this.#cancelPrefetch();\n    const prefetchEnabled = ytmusic.getConfigValue('prefetch');\n    if (!prefetchEnabled) {\n      /**\n       * Volumio doesn't check whether `prefetch()` is actually performed or\n       * successful (such as inspecting the result of the function call) -\n       * it just sets its internal state variable `prefetchDone`\n       * to `true`. This results in the next track being skipped in cases\n       * where prefetch is not performed or fails. So we set statemachine's\n       * `prefetchDone` variable to `false` and only set it to `true` when\n       * prefetch is successful.\n       */\n      ytmusic.getLogger().info('[ytmusic-play] Prefetch disabled');\n      ytmusic.getStateMachine().prefetchDone = false;\n      return;\n    }\n    let streamUrl;\n    // Only set `prefetchDone` to `true` on success.\n    // Volumio gives us 5 seconds to prefetch before going to next song,\n    // setting this to `false` will make it play next track without prefetch\n    // - this can happen if prefetch fails or takes too long.\n    ytmusic.getStateMachine().prefetchDone = false;\n    this.#prefetchAborter = new AbortController();\n    const signal = this.#prefetchAborter.signal;\n    try {\n      const { videoId, info: playbackInfo } = await PlayController.getPlaybackInfoFromUri(track.uri, signal);\n      streamUrl = playbackInfo?.stream?.url;\n      if (!streamUrl || !playbackInfo) {\n        throw Error(`Stream not found for: '${videoId}'`);\n      }\n      this.#updateTrackWithPlaybackInfo(track, playbackInfo);\n      ytmusic.getStateMachine().prefetchDone = true;\n    }\n    catch (error: any) {\n      if (signal.aborted) {\n        ytmusic.getLogger().info(`[ytmusic-play] Prefetch aborted: ${track.name}`);\n        return;\n      }\n      ytmusic.getLogger().error(`[ytmusic-play] Prefetch failed: ${error}`);\n      return;\n    }\n    finally {\n      this.#prefetchAborter = null;\n    }\n\n    const mpdPlugin = this.#mpdPlugin;\n    const res = await kewToJSPromise(mpdPlugin.sendMpdCommand(`addid \"${this.#appendTrackTypeToStreamUrl(streamUrl)}\"`, [])\n      .then((addIdResp: { Id: string }) => this.#mpdAddTags(addIdResp, track))\n      .then(() => {\n        ytmusic.getLogger().info(`[ytmusic-play] Prefetched and added track to MPD queue: ${track.name}`);\n        return mpdPlugin.sendMpdCommand('consume 1', []);\n      }));\n\n    this.#prefetchPlaybackStateFixer?.notifyPrefetched(track);\n\n    return res;\n  }\n\n  #cancelPrefetch() {\n    if (this.#prefetchAborter) {\n      this.#prefetchAborter.abort();\n      this.#prefetchAborter = null;\n    }\n  }\n\n  async getGotoUri(type: 'album' | 'artist', uri: QueueItem['uri']): Promise<string | null> {\n    const playbackInfo = (await PlayController.getPlaybackInfoFromUri(uri))?.info;\n    if (!playbackInfo) {\n      return null;\n    }\n\n    if (type === 'album' && playbackInfo.album.albumId) {\n      const targetView: AlbumView = {\n        name: 'album',\n        endpoints: {\n          browse: {\n            type: EndpointType.Browse,\n            payload: {\n              browseId: playbackInfo.album.albumId\n            }\n          },\n          // `watch` endpoint is actually not necessary in GoTo context, but required by AlbumView.\n          watch: {\n            type: EndpointType.Watch,\n            payload: {\n              playlistId: playbackInfo.album.albumId\n            }\n          }\n        }\n      };\n      return `ytmusic/${ViewHelper.constructUriSegmentFromView(targetView)}`;\n    }\n\n    if (type === 'artist' && playbackInfo.artist.channelId) {\n      const targetView: GenericView = {\n        name: 'generic',\n        endpoint: {\n          type: EndpointType.Browse,\n          payload: {\n            browseId: playbackInfo.artist.channelId\n          }\n        }\n      };\n      return `ytmusic/${ViewHelper.constructUriSegmentFromView(targetView)}`;\n    }\n\n    return null;\n  }\n}\n\n/**\n * Given state is updated by calling `setConsumeUpdateService('mpd', true)` (`consumeIgnoreMetadata`: true), when moving to\n * prefetched track there's no guarantee the state machine will store the correct consume state obtained from MPD. It depends on\n * whether the state machine increments `currentPosition` before or after MPD calls `pushState()`. The intended\n * order is 'before' - but because the increment is triggered through a timer, it is possible that MPD calls `pushState()` first,\n * thereby causing the state machine to store the wrong state info (title, artist, album...obtained from trackBlock at\n * `currentPosition` which has not yet been incremented).\n *\n * See state machine `syncState()` and  `increasePlaybackTimer()`.\n *\n * `PrefetchPlaybackStateFixer` checks whether the state is consistent when prefetched track is played and `currentPosition` updated\n * and triggers an MPD `pushState()` if necessary.\n */\nclass PrefetchPlaybackStateFixer extends EventEmitter {\n\n  #positionAtPrefetch: number;\n  #prefetchedTrack: QueueItem | null;\n  #volumioPushStateListener: ((state: any) => void) | null;\n\n  constructor() {\n    super();\n    this.#positionAtPrefetch = -1;\n    this.#prefetchedTrack = null;\n  }\n\n  reset() {\n    this.#removePushStateListener();\n    this.removeAllListeners();\n  }\n\n  notifyPrefetched(track: QueueItem) {\n    this.#positionAtPrefetch = ytmusic.getStateMachine().currentPosition;\n    this.#prefetchedTrack = track;\n    this.#addPushStateListener();\n  }\n\n  notifyPrefetchCleared() {\n    this.#removePushStateListener();\n  }\n\n  #addPushStateListener() {\n    if (!this.#volumioPushStateListener) {\n      this.#volumioPushStateListener = this.#handleVolumioPushState.bind(this);\n      ytmusic.volumioCoreCommand?.addCallback('volumioPushState', this.#volumioPushStateListener);\n    }\n  }\n\n  #removePushStateListener() {\n    if (this.#volumioPushStateListener) {\n      const listeners = ytmusic.volumioCoreCommand?.callbacks?.['volumioPushState'] || [];\n      const index = listeners.indexOf(this.#volumioPushStateListener);\n      if (index >= 0) {\n        ytmusic.volumioCoreCommand.callbacks['volumioPushState'].splice(index, 1);\n      }\n      this.#volumioPushStateListener = null;\n      this.#positionAtPrefetch = -1;\n      this.#prefetchedTrack = null;\n    }\n  }\n\n  #handleVolumioPushState(state: any) {\n    const sm = ytmusic.getStateMachine();\n    const currentPosition = sm.currentPosition as number;\n    if (sm.getState().service !== 'ytmusic') {\n      this.#removePushStateListener();\n      return;\n    }\n    if (this.#positionAtPrefetch >= 0 && this.#positionAtPrefetch !== currentPosition) {\n      const track = sm.getTrack(currentPosition);\n      const pf = this.#prefetchedTrack;\n      this.#removePushStateListener();\n      if (track && state && pf && track.service === 'ytmusic' && pf.uri === track.uri) {\n        if (state.uri !== track.uri) {\n          const mpdPlugin = ytmusic.getMpdPlugin();\n          mpdPlugin.getState().then((st: any) => mpdPlugin.pushState(st));\n        }\n        this.emit('playPrefetch', {\n          track: pf,\n          position: currentPosition\n        });\n      }\n    }\n  }\n\n  emit(event: 'playPrefetch', info: { track: QueueItem; position: number; }): boolean;\n  emit(event: string | symbol, ...args: any[]): boolean {\n    return super.emit(event, ...args);\n  }\n\n  on(event: 'playPrefetch', listener: (info: { track: QueueItem; position: number; }) => void): this;\n  on(event: string | symbol, listener: (...args: any[]) => void): this {\n    super.on(event, listener);\n    return this;\n  }\n}\n"]}