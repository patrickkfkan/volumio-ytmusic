{"version":3,"file":"Auth.js","sourceRoot":"","sources":["../../../src/lib/util/Auth.ts"],"names":[],"mappings":"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","sourcesContent":["import {type OAuth2Tokens, type DeviceAndUserCode, type Utils as YTUtils} from 'volumio-youtubei.js';\nimport type Innertube from 'volumio-youtubei.js';\nimport ytmusic from '../YTMusicContext';\nimport EventEmitter from 'events';\n\nexport enum AuthStatus {\n  SignedIn = 'SignedIn',\n  SignedOut = 'SignedOut',\n  SigningIn = 'SigningIn',\n  Error = 'Error'\n}\n\nexport interface AuthStatusInfo {\n  status: AuthStatus;\n  verificationInfo?: {\n    verificationUrl: string,\n    userCode: string\n  } | null;\n  error?: YTUtils.OAuth2Error;\n}\n\nconst INITIAL_SIGNED_OUT_STATUS: AuthStatusInfo = {\n  status: AuthStatus.SignedOut,\n  verificationInfo: null\n};\n\nexport enum AuthEvent {\n  SignIn = 'SignIn',\n  SignOut = 'SignOut',\n  Pending = 'Pending',\n  Error = 'Error'\n}\n\nexport default class Auth extends EventEmitter {\n\n  #innertube: Innertube | null;\n  #handlers: any;\n  #handlersRegistered: boolean;\n\n  constructor() {\n    super();\n    this.#innertube = null;\n    this.#handlersRegistered = false;\n  }\n\n  static create(innertube: Innertube) {\n    const auth = new Auth();\n    auth.#innertube = innertube;\n    auth.#handlers = {\n      onSuccess: auth.#handleSuccess.bind(auth),\n      onPending: auth.#handlePending.bind(auth),\n      onError: auth.#handleError.bind(auth),\n      onCredentials: auth.#handleSuccess.bind(auth)\n    };\n    return auth;\n  }\n\n  dispose() {\n    this.#unregisterHandlers();\n    this.removeAllListeners();\n    this.#innertube = null;\n  }\n\n  #handlePending(data: DeviceAndUserCode) {\n    ytmusic.set<AuthStatusInfo>('authStatusInfo', {\n      status: AuthStatus.SignedOut,\n      verificationInfo: {\n        verificationUrl: data.verification_url,\n        userCode: data.user_code\n      }\n    });\n    ytmusic.getLogger().info(`[ytmusic] Obtained device code for sign-in (expires in ${data.expires_in} seconds)`);\n    ytmusic.refreshUIConfig();\n    this.emit(AuthEvent.Pending);\n  }\n\n  #handleSuccess(data: { credentials: OAuth2Tokens }) {\n    ytmusic.setConfigValue('authCredentials', data.credentials);\n    ytmusic.getLogger().info('[ytmusic] Auth credentials updated');\n  }\n\n  #handleError(err: YTUtils.OAuth2Error) {\n    if (err.info.error === 'expired_token') {\n      ytmusic.getLogger().info('[ytmusic] Device code for sign-in expired - refetch');\n      this.signIn(); // This will refetch the code and refresh UI config\n      return;\n    }\n    ytmusic.set<AuthStatusInfo>('authStatusInfo', {\n      status: AuthStatus.Error,\n      error: err\n    });\n    ytmusic.toast('error', ytmusic.getI18n('YTMUSIC_ERR_SIGN_IN', ytmusic.getErrorMessage('', err, false)));\n    ytmusic.refreshUIConfig();\n    this.emit(AuthEvent.Error);\n  }\n\n  #registerHandlers() {\n    if (this.#innertube?.session && !this.#handlersRegistered) {\n      this.#innertube.session.on('auth', this.#handlers.onSuccess);\n      this.#innertube.session.on('auth-pending', this.#handlers.onPending);\n      this.#innertube.session.on('auth-error', this.#handlers.onError);\n      this.#innertube.session.on('update-credentials', this.#handlers.onCredentials);\n      this.#handlersRegistered = true;\n    }\n  }\n\n  #unregisterHandlers() {\n    if (this.#innertube?.session) {\n      this.#innertube.session.off('auth', this.#handlers.onSuccess);\n      this.#innertube.session.off('auth-pending', this.#handlers.onPending);\n      this.#innertube.session.off('auth-error', this.#handlers.onError);\n      this.#innertube.session.off('update-credentials', this.#handlers.onCredentials);\n    }\n    this.#handlersRegistered = false;\n  }\n\n  signIn() {\n    if (this.#innertube?.session) {\n      const credentials = ytmusic.getConfigValue('authCredentials');\n      if (credentials) {\n        ytmusic.set<AuthStatusInfo>('authStatusInfo', {\n          status: AuthStatus.SigningIn\n        });\n        ytmusic.getLogger().info('[ytmusic] Attempt sign-in with existing credentials');\n      }\n      else {\n        ytmusic.set('authStatusInfo', INITIAL_SIGNED_OUT_STATUS);\n        ytmusic.getLogger().info('[ytmusic] Obtaining device code for sign-in...');\n      }\n\n      this.#registerHandlers();\n      ytmusic.refreshUIConfig();\n      this.#innertube.session.signIn(credentials)\n      .then(() => {\n        const oldStatusInfo = ytmusic.get<AuthStatusInfo>('authStatusInfo');\n        if (this.#innertube?.session.logged_in && (!oldStatusInfo || oldStatusInfo.status !== AuthStatus.SignedIn)) {\n          ytmusic.set<AuthStatusInfo>('authStatusInfo', {\n            status: AuthStatus.SignedIn\n          });\n          ytmusic.getLogger().info('[ytmusic] Auth success');\n          ytmusic.toast('success', ytmusic.getI18n('YTMUSIC_SIGN_IN_SUCCESS'));\n          ytmusic.refreshUIConfig();\n          this.emit(AuthEvent.SignIn);\n        }\n      })\n      .catch((error: unknown) => {\n        ytmusic.getLogger().error(ytmusic.getErrorMessage('[ytmusic] Caught Innertube sign-in error:', error, false));\n      });\n    }\n  }\n\n  async signOut() {\n    if (this.#innertube?.session?.logged_in) {\n      await this.#innertube.session.signOut();\n\n      ytmusic.deleteConfigValue('authCredentials');\n      ytmusic.set<AuthStatusInfo>('authStatusInfo', INITIAL_SIGNED_OUT_STATUS);\n\n      ytmusic.getLogger().info('[ytmusic] Auth revoked');\n      ytmusic.toast('success', ytmusic.getI18n('YTMUSIC_SIGNED_OUT'));\n\n      this.emit(AuthEvent.SignOut);\n      ytmusic.refreshUIConfig();\n    }\n  }\n\n  getStatus() {\n    return ytmusic.get<AuthStatusInfo>('authStatusInfo') || INITIAL_SIGNED_OUT_STATUS;\n  }\n}\n"]}